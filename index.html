<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CobaCode</title>
  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/material-darker.min.css">
  <style>
    body { margin:0; font-family:Arial, sans-serif; height:100vh; display:flex; flex-direction:column; }
    header { background:#222; color:#fff; padding:8px 16px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { font-size:16px; margin:0; }
    .header-buttons button { margin-left:6px; padding:5px 12px; border:none; border-radius:4px; cursor:pointer; background:#4CAF50; color:white; }
    main { flex:1; display:flex; overflow:hidden; }
    .editor-container { width:50%; display:flex; flex-direction:column; }
    .tabs { display:flex; background:#333; }
    .tabs button { flex:1; padding:6px; border:none; background:#333; color:#fff; cursor:pointer; }
    .tabs button.active { background:#4CAF50; }
    .editor { flex:1; display:none; }
    .editor.active { display:block; }
    .CodeMirror { height:100%; }
    .preview-container { width:50%; display:flex; flex-direction:column; border-left:1px solid #444; }
    .browser-tabs { display:flex; background:#ddd; border-bottom:1px solid #aaa; }
    .browser-tab { padding:4px 10px; border-right:1px solid #aaa; cursor:pointer; background:#ccc; font-size:13px; }
    .browser-tab.active { background:#fff; font-weight:bold; }
    .browser-tab.add { background:#4CAF50; color:white; }
    .browser-header { background:#f5f5f5; border-bottom:1px solid #ccc; display:flex; align-items:center; gap:6px; padding:4px 8px; font-size:13px; }
    .browser-header img { width:16px; height:16px; }
    .browser-url { flex:1; font-size:13px; border:1px solid #ccc; border-radius:3px; padding:2px 6px; background:#fff; color:#555; }
    .preview-frame { flex:1; border:none; display:none; }
    .preview-frame.active { display:block; }
    #errorBox { background:#f44336; color:#fff; padding:4px 8px; display:none; font-size:13px; }
    footer { background:#222; color:#fff; text-align:center; font-size:13px; padding:6px; }
  </style>
</head>
<body>
  <header>
    <h1>CobaCode</h1>
    <div class="header-buttons">
      <button onclick="runCode()">Run</button>
      <button onclick="saveAsFile()">Save As</button>
    </div>
  </header>

  <main>
    <div class="editor-container">
      <div class="tabs">
        <button class="tab-btn active" onclick="openTab('html')">HTML</button>
        <button class="tab-btn" onclick="openTab('css')">CSS</button>
        <button class="tab-btn" onclick="openTab('js')">JavaScript</button>
      </div>
      <div id="editor-html" class="editor active"></div>
      <div id="editor-css" class="editor"></div>
      <div id="editor-js" class="editor"></div>
      <div id="errorBox"></div>
    </div>

    <div class="preview-container">
      <div class="browser-tabs" id="browserTabs">
        <div class="browser-tab active" onclick="switchPreview(0)">Tab 1</div>
        <div class="browser-tab add" onclick="addPreviewTab()">+</div>
      </div>
      <div class="browser-header">
        <img id="preview-favicon" src="favicon.png" alt="icon">
        <span id="preview-title">Preview Page</span>
        <input class="browser-url" id="preview-url" type="text" value="https://smaink-coding.com/" readonly>
      </div>
      <iframe class="preview-frame active"></iframe>
    </div>
  </main>

  <footer>
    © 2025 dibuat dengan ❤️ oleh Agus Widodo FN.
  </footer>

  <!-- CodeMirror JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/htmlmixed/htmlmixed.min.js"></script>

  <script>
    let editors = {};
    let previewFrames = [];

    function initEditors() {
      editors.html = CodeMirror(document.getElementById("editor-html"), {
        mode: "text/html",
        theme: "material-darker",
        lineNumbers: true
      });
      editors.css = CodeMirror(document.getElementById("editor-css"), {
        mode: "css", theme: "material-darker", lineNumbers: false
      });
      editors.js = CodeMirror(document.getElementById("editor-js"), {
        mode: "javascript", theme: "material-darker", lineNumbers: false
      });

      // default content
      editors.html.setValue(localStorage.getItem("htmlCode") || 
`<!DOCTYPE html>
<html>
<head>
  <title>Belajar Coding</title>
  <link rel="icon" href="favicon.png">
</head>
<body>
  <h1>Hello Murid SMAINK!</h1>
  <p>Ini adalah contoh halaman HTML.</p>
</body>
</html>`);
      editors.css.setValue(localStorage.getItem("cssCode") || 
`body { font-family: Arial, sans-serif; background: #f0f0f0; color: #333; }
h1 { color: #4CAF50; }`);
      editors.js.setValue(localStorage.getItem("jsCode") || `console.log("Hello from JavaScript!");`);

      Object.values(editors).forEach(ed => ed.on("change", runCode));
    }

    function openTab(tab) {
      document.querySelectorAll('.editor').forEach(el => el.classList.remove('active'));
      document.getElementById("editor-" + tab).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      editors[tab].refresh();
    }

    function runCode() {
      const htmlContent = editors.html.getValue();
      const cssContent = editors.css.getValue();
      const jsContent = editors.js.getValue();

      const titleMatch = htmlContent.match(/<title>(.*?)<\/title>/i);
      const pageTitle = titleMatch ? titleMatch[1] : "Preview Page";
      document.getElementById("preview-title").innerText = pageTitle;

      const faviconMatch = htmlContent.match(/<link[^>]+rel=["']icon["'][^>]*>/i);
      let faviconUrl = "favicon.png";
      if (faviconMatch) {
        const hrefMatch = faviconMatch[0].match(/href=["']([^"']+)["']/i);
        if (hrefMatch) faviconUrl = hrefMatch[1];
      }
      document.getElementById("preview-favicon").src = faviconUrl;

      document.getElementById("preview-url").value = "https://smaink-coding.com/";

      const finalDoc = `
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>${pageTitle}</title>
<link rel="icon" href="${faviconUrl}">
<style>${cssContent}</style>
</head>
<body>
${htmlContent}
<script>${jsContent}<\/script>
</body>
</html>`;

      // render di tab aktif
      const activeFrame = document.querySelector(".preview-frame.active").contentDocument;
      activeFrame.open(); activeFrame.write(finalDoc); activeFrame.close();

      localStorage.setItem("htmlCode", htmlContent);
      localStorage.setItem("cssCode", cssContent);
      localStorage.setItem("jsCode", jsContent);

      checkErrors(htmlContent);
    }

    function addPreviewTab() {
      const newIndex = previewFrames.length + 1;
      const newTab = document.createElement("div");
      newTab.className = "browser-tab";
      newTab.innerText = "Tab " + newIndex;
      newTab.onclick = () => switchPreview(newIndex - 1);

      document.getElementById("browserTabs").insertBefore(newTab, document.querySelector(".browser-tab.add"));

      const newFrame = document.createElement("iframe");
      newFrame.className = "preview-frame";
      document.querySelector(".preview-container").appendChild(newFrame);
      previewFrames.push(newFrame);

      switchPreview(newIndex - 1);
      runCode();
    }

    function switchPreview(index) {
      document.querySelectorAll(".browser-tab").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".preview-frame").forEach(frame => frame.classList.remove("active"));

      const tabs = document.querySelectorAll(".browser-tab");
      tabs[index].classList.add("active");

      const frames = document.querySelectorAll(".preview-frame");
      frames[index].classList.add("active");
    }

    function checkErrors(html) {
      const errorBox = document.getElementById("errorBox");
      errorBox.style.display = "none";
      const openTags = [];
      const regex = /<\/?([a-zA-Z0-9]+)(\s[^>]*)?>/g;
      let match;
      const voidElements = ["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"];

      while ((match = regex.exec(html)) !== null) {
        const tagName = match[1].toLowerCase();
        if (match[0][1] === "/") {
          if (voidElements.includes(tagName)) continue;
          if (openTags.length === 0 || openTags[openTags.length - 1] !== tagName) {
            errorBox.innerText = `Error: Tag penutup </${tagName}> tidak sesuai.`;
            errorBox.style.display = "block";
            return;
          }
          openTags.pop();
        } else {
          if (!voidElements.includes(tagName)) {
            openTags.push(tagName);
          }
        }
      }
      if (openTags.length > 0) {
        errorBox.innerText = `Error: Tag <${openTags[openTags.length-1]}> belum ditutup.`;
        errorBox.style.display = "block";
      }
    }

    function saveAsFile() {
      const htmlContent = editors.html.getValue();
      const cssContent = editors.css.getValue();
      const jsContent = editors.js.getValue();
      const finalCode = `
<!DOCTYPE html>
<html>
<head>
<style>${cssContent}</style>
</head>
<body>
${htmlContent}
<script>${jsContent}<\/script>
</body>
</html>`;
      const blob = new Blob([finalCode], { type: "text/html" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "my-code.html";
      link.click();
    }

    window.onload = () => {
      initEditors();
      previewFrames = [document.querySelector(".preview-frame")];
      openTab("html");
      runCode();
    };
  </script>
</body>
</html>
