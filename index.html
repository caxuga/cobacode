<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CobaCode</title>

  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/material-darker.min.css">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #222;
      color: #fff;
      padding: 8px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 16px; margin: 0; }
    .header-buttons button {
      margin-left: 6px;
      padding: 5px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    .editor-container {
      width: 50%;
      display: flex;
      flex-direction: column;
    }
    .tabs {
      display: flex;
      background: #333;
    }
    .tabs button {
      flex: 1;
      padding: 6px;
      border: none;
      background: #333;
      color: #fff;
      cursor: pointer;
    }
    .tabs button.active { background: #4CAF50; }
    .editor { flex: 1; display: none; }
    .editor.active { display: block; }
    .CodeMirror { height: 100%; }

    /* Browser-style preview */
    .preview-container {
      width: 50%;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #444;
    }
    .browser-tabs {
      background: #ddd;
      display: flex;
      align-items: center;
      padding: 2px;
      gap: 2px;
    }
    .browser-tab {
      background: #eee;
      padding: 2px 8px;
      border-radius: 4px 4px 0 0;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      position: relative;
    }
    .browser-tab.active { background: #fff; border-bottom: 2px solid #4CAF50; }
    .browser-tab img { width: 14px; height: 14px; }
    .browser-tab .close-btn {
      margin-left: 6px;
      cursor: pointer;
      font-weight: bold;
      color: #888;
    }
    .browser-tab .close-btn:hover { color: #f00; }
    .add-tab { padding: 0 6px; cursor: pointer; font-weight: bold; color: #555; }

    .browser-header {
      background: #f5f5f5;
      border-bottom: 1px solid #ccc;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      font-size: 13px;
    }
    #preview-url {
      flex: 1;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 2px 6px;
      background: #fff;
      color: #555;
    }
    #preview { flex: 1; border: none; background: #fff; }

    #errorBox {
      background: #f44336;
      color: #fff;
      padding: 4px 8px;
      display: none;
      font-size: 13px;
    }
    footer {
      background: #222;
      color: #fff;
      text-align: center;
      font-size: 13px;
      padding: 6px;
    }
  </style>
</head>
<body>
  <header>
    <h1>CobaCode</h1>
    <div class="header-buttons">
      <button onclick="runCode()">Run</button>
      <button onclick="saveAsFile()">Save As</button>
    </div>
  </header>

  <main>
    <!-- Editor -->
    <div class="editor-container">
      <div class="tabs">
        <button class="tab-btn active" onclick="openTab('html')">HTML</button>
        <button class="tab-btn" onclick="openTab('css')">CSS</button>
        <button class="tab-btn" onclick="openTab('js')">JavaScript</button>
      </div>
      <div id="editor-html" class="editor active"></div>
      <div id="editor-css" class="editor"></div>
      <div id="editor-js" class="editor"></div>
      <div id="errorBox"></div>
    </div>

    <!-- Preview -->
    <div class="preview-container">
      <div id="browser-tabs" class="browser-tabs">
        <!-- Tab dinamis -->
        <div class="add-tab" onclick="addBrowserTab()">+</div>
      </div>
      <div class="browser-header">
        <input id="preview-url" type="text" value="https://smaink-coding.com/" readonly>
      </div>
      <iframe id="preview"></iframe>
    </div>
  </main>

  <footer>
    © 2025 dibuat dengan ❤️ oleh Agus Widodo FN.
  </footer>

  <!-- CodeMirror JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/htmlmixed/htmlmixed.min.js"></script>

  <script>
    let editors = {};
    let tabs = [];
    let currentTabId = null;

    function initEditors() {
      editors.html = CodeMirror(document.getElementById("editor-html"), {
        mode: "text/html", theme: "material-darker", lineNumbers: true
      });
      editors.css = CodeMirror(document.getElementById("editor-css"), {
        mode: "css", theme: "material-darker", lineNumbers: false
      });
      editors.js = CodeMirror(document.getElementById("editor-js"), {
        mode: "javascript", theme: "material-darker", lineNumbers: false
      });

      editors.html.setValue(localStorage.getItem("htmlCode") || 
`<!DOCTYPE html>
<html>
<head>
  <title>Belajar Coding</title>
  <link rel="icon" href="favicon.png">
</head>
<body>
  <h1>Hello SMAINK!</h1>
  <p>Ini contoh halaman HTML.</p>
</body>
</html>`);
      editors.css.setValue(localStorage.getItem("cssCode") || 
`body { font-family: Arial, sans-serif; background: #f0f0f0; color: #333; }
h1 { color: #4CAF50; }`);
      editors.js.setValue(localStorage.getItem("jsCode") || 
`console.log("Hello from JavaScript!");`);

      Object.values(editors).forEach(ed => ed.on("change", runCode));
      addBrowserTab();
    }

    function openTab(tab) {
      document.querySelectorAll('.editor').forEach(el => el.classList.remove('active'));
      document.getElementById("editor-" + tab).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      editors[tab].refresh();
    }

    function addBrowserTab() {
      const id = "tab" + (Date.now());
      const tabEl = document.createElement("div");
      tabEl.className = "browser-tab";
      tabEl.id = id;
      tabEl.innerHTML = `<img src="favicon.png"><span>New Tab</span><span class="close-btn" onclick="closeTab(event, '${id}')">×</span>`;
      tabEl.onclick = (e) => { if (!e.target.classList.contains("close-btn")) activateTab(id); };
      const addBtn = document.querySelector(".add-tab");
      document.getElementById("browser-tabs").insertBefore(tabEl, addBtn);
      tabs.push({id, title: "New Tab", favicon: "favicon.png"});
      activateTab(id);
      runCode();
    }

    function activateTab(id) {
      currentTabId = id;
      document.querySelectorAll(".browser-tab").forEach(t => t.classList.remove("active"));
      const tabEl = document.getElementById(id);
      if (tabEl) tabEl.classList.add("active");
    }

    function closeTab(event, id) {
      event.stopPropagation();
      const tabEl = document.getElementById(id);
      if (tabEl) tabEl.remove();
      tabs = tabs.filter(t => t.id !== id);
      if (currentTabId === id && tabs.length > 0) {
        activateTab(tabs[0].id);
        runCode();
      }
    }

    function runCode() {
      if (!currentTabId) return;

      const htmlContent = editors.html.getValue();
      const cssContent = editors.css.getValue();
      const jsContent = editors.js.getValue();

      const titleMatch = htmlContent.match(/<title>(.*?)<\/title>/i);
      const pageTitle = titleMatch ? titleMatch[1] : "Preview Page";

      const faviconMatch = htmlContent.match(/<link[^>]+rel=["']icon["'][^>]*>/i);
      let faviconUrl = "favicon.png";
      if (faviconMatch) {
        const hrefMatch = faviconMatch[0].match(/href=["']([^"']+)["']/i);
        if (hrefMatch) faviconUrl = hrefMatch[1];
      }

      const activeTab = document.getElementById(currentTabId);
      if (activeTab) {
        activeTab.querySelector("span").innerText = pageTitle;
        activeTab.querySelector("img").src = faviconUrl;
      }

      const finalDoc = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>${pageTitle}</title>
<link rel="icon" href="${faviconUrl}">
<style>${cssContent}</style>
</head>
<body>
${htmlContent}
<script>${jsContent}<\/script>
</body>
</html>`;
      const iframeDoc = document.getElementById("preview").contentDocument;
      iframeDoc.open(); iframeDoc.write(finalDoc); iframeDoc.close();

      document.getElementById("preview-url").value = "https://smaink-coding.com/";

      localStorage.setItem("htmlCode", htmlContent);
      localStorage.setItem("cssCode", cssContent);
      localStorage.setItem("jsCode", jsContent);

      checkErrors(htmlContent);
    }

    function checkErrors(html) {
      const errorBox = document.getElementById("errorBox");
      errorBox.style.display = "none";
      const openTags = [];
      const regex = /<\/?([a-zA-Z0-9]+)(\s[^>]*)?>/g;
      let match;
      const voidElements = ["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"];

      while ((match = regex.exec(html)) !== null) {
        const tagName = match[1].toLowerCase();
        if (match[0][1] === "/") {
          if (voidElements.includes(tagName)) continue;
          if (openTags.length === 0 || openTags[openTags.length - 1] !== tagName) {
            errorBox.innerText = `Error: Tag penutup </${tagName}> tidak sesuai.`;
            errorBox.style.display = "block";
            return;
          }
          openTags.pop();
        } else {
          if (!voidElements.includes(tagName)) openTags.push(tagName);
        }
      }
      if (openTags.length > 0) {
        errorBox.innerText = `Error: Tag <${openTags[openTags.length-1]}> belum ditutup.`;
        errorBox.style.display = "block";
      }
    }

    function saveAsFile() {
      const htmlContent = editors.html.getValue();
      const cssContent = editors.css.getValue();
      const jsContent = editors.js.getValue();
      const finalCode = `
<!DOCTYPE html>
<html>
<head>
<style>${cssContent}</style>
</head>
<body>
${htmlContent}
<script>${jsContent}<\/script>
</body>
</html>`;
      const blob = new Blob([finalCode], { type: "text/html" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "my-code.html";
      link.click();
    }

    window.onload = () => { initEditors(); openTab("html"); runCode(); };
  </script>
</body>
</html>
